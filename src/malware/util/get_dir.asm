; readdir usage (32 bit)
; By i4k
;
; This file show how you can use the readdir malelf macro        
;
%include "inc/util.inc.asm"


global _start

section .text

_start:
        prologue

        ;; push the directory '.' to scan
        push word 0x002e
        readdir

        next_file_start_loop
; next file in ebx, print them
        push ebx
        call print

; print new line
        push dword 0x0000000a
        push esp
        call print
        add esp, 8              ; descarta o parametro da stack

        pop ebx

        next_file_end_loop

        call exit

read_file_error:
        epilogue
        ret
; unsigned int stringlen(char* str);
stringlen:
        prologue

        mov ecx, [ebp+8]    ; primeiro parametro
        xor eax, eax        ; contador

stringlen_loopStart:
        xor dx, dx
        mov dl, byte [ecx+eax]
        inc eax

        cmp dl, 0x0 ; null byte
        jne stringlen_loopStart
stringlen_loopEnd:
        epilogue
        ret

; void print(char* msg)
print:
        prologue

        mov ecx, [ebp+8]
        push ecx
        call stringlen
        add esp, 4      ; descarta parametro

        mov edx, eax    ; tamanho da string em eax
        xor ebx, ebx
        xor eax, eax
        mov ebx, 1  ; standard output
        mov al, sys_write
        int 0x80

        epilogue
        ret
        
exit:
        xor eax, eax
        inc eax
        int 0x80
        ret

